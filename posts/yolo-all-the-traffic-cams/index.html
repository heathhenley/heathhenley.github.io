<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>YOLO-ing All the Traffic Cams</title><meta property="og:title" content="YOLO-ing All the Traffic Cams"><meta name=twitter:title content="YOLO-ing All the Traffic Cams"><meta name=author content="Heath Henley"><meta property="og:site_name" content="Blogging by Heathâ„¢"><meta property="og:url" content="https://heathhenley.github.io/posts/yolo-all-the-traffic-cams/"><meta name=twitter:card content="summary"><meta property="og:type" content="article"><meta name=generator content="Hugo 0.112.3"><script async src="https://www.googletagmanager.com/gtag/js?id=G-LHHPTPJRGL"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LHHPTPJRGL")</script><link rel=stylesheet href=https://heathhenley.github.io/css/style.css><link rel=stylesheet href=https://heathhenley.github.io/css/custom.css><link rel=icon type=image/x-icon href=https://heathhenley.github.io/favicon.png><script type=text/javascript src=https://heathhenley.github.io/js/bundle.js></script></head><body><a href=#main class="skip-link p-screen-reader-text">Skip to content</a><svg xmlns="http://www.w3.org/2000/svg" style="display:none" aria-hidden="true"><symbol id="icon-500px" viewBox="0 0 16 16"><g><path d="M3.953 10.512a5.24 5.24.0 006.996 3.141c.625-.262 1.184-.641 1.666-1.122s.859-1.041 1.122-1.666c.272-.647.412-1.331.412-2.037s-.137-1.394-.412-2.037c-.262-.625-.641-1.184-1.122-1.666s-1.041-.859-1.666-1.122A5.226 5.226.0 008.912 3.59c-.716.0-1.431.144-2.066.413-.509.216-1.372.769-1.875 1.291l-.003.003V.984h7.241c.262-.003.262-.372.262-.491.0-.122.0-.487-.266-.491H4.377a.343.343.0 00-.344.341v6.066c0 .197.244.338.472.384.444.094.544-.047.653-.197l.016-.019c.166-.247.681-.766.688-.772a4.262 4.262.0 013.037-1.25c1.147.0 2.222.444 3.028 1.25a4.245 4.245.0 011.256 3.019 4.236 4.236.0 01-1.25 3.019 4.336 4.336.0 01-3.047 1.25 4.136 4.136.0 01-2.159-.597l.003-3.688c0-.491.213-1.028.572-1.431a2.09 2.09.0 011.588-.716c.594.0 1.15.225 1.566.634.409.406.637.95.637 1.528A2.179 2.179.0 018.887 11.02c-.238.0-.672-.106-.691-.109-.25-.075-.356.272-.391.387-.134.441.069.528.109.541.397.125.659.147 1.003.147a3.173 3.173.0 003.169-3.169c0-1.734-1.422-3.144-3.166-3.144-.856.0-1.659.328-2.263.919-.575.566-.903 1.319-.903 2.069v.019c-.003.094-.003 2.306-.006 3.031l-.003-.003c-.328-.363-.653-.919-.869-1.488-.084-.222-.275-.184-.534-.103-.125.034-.469.141-.391.394zm3.722-.865c0 .106.097.2.156.253l.019.019c.1.097.194.147.281.147a.181.181.0 00.131-.05c.044-.041.537-.544.588-.591l.553.55c.05.056.106.088.172.088.088.0.184-.053.284-.156.238-.244.119-.375.063-.438l-.559-.559.584-.588c.128-.137.016-.284-.097-.397-.162-.162-.322-.206-.422-.112l-.581.581-.588-.588a.16.16.0 00-.113-.047c-.078.0-.172.053-.275.156-.181.181-.219.306-.125.406l.588.584-.584.584c-.053.05-.078.103-.075.156zm1.278-7.931c-.938.0-1.938.191-2.669.506a.207.207.0 00-.134.181.753.753.0 00.069.337c.047.116.166.425.4.334a6.689 6.689.0 012.334-.444 6.35 6.35.0 012.469.497c.622.263 1.206.644 1.844 1.194a.22.22.0 00.147.059c.125.0.244-.122.347-.237.169-.191.287-.35.119-.509a6.858 6.858.0 00-2.1-1.356 7.326 7.326.0 00-2.825-.563zM14.006 13.3c-.113-.113-.209-.178-.294-.203s-.162-.006-.222.053l-.056.056a6.32 6.32.0 01-6.938 1.356 6.336 6.336.0 01-2.013-1.356 6.046 6.046.0 01-1.356-2.012c-.288-.713-.381-1.247-.413-1.422-.003-.016-.006-.028-.006-.037-.041-.206-.231-.222-.503-.178-.112.019-.459.072-.428.319v.006a7.261 7.261.0 002.04 3.994 7.266 7.266.0 0010.288.0l.059-.059c.069-.084.134-.225-.159-.516z"/></g></symbol><symbol id="icon-codepen" viewBox="0 0 16 16"><g><path d="M14.777 5.751l-7-4.667a.5.5.0 00-.555.0l-7 4.667a.501.501.0 00-.223.416v4.667c0 .167.084.323.223.416l7 4.667a.5.5.0 00.554.0l7-4.667a.501.501.0 00.223-.416V6.167a.501.501.0 00-.223-.416zM7.5 10.232 4.901 8.5 7.5 6.768 10.099 8.5 7.5 10.232zM8 5.899V2.434l5.599 3.732L11 7.898l-3-2zm-1 0-3 2-2.599-1.732L7 2.435V5.9zM3.099 8.5 1 9.899V7.101L3.099 8.5zM4 9.101l3 2v3.465l-5.599-3.732L4 9.102zm4 2 3-2 2.599 1.732L8 14.565V11.1zM11.901 8.5 14 7.101v2.798L11.901 8.5z"/></g></symbol><symbol id="icon-dribbble" viewBox="0 0 16 16"><g><path d="M8 16c-4.412.0-8-3.588-8-8s3.587-8 8-8c4.412.0 8 3.587 8 8s-3.588 8-8 8zm6.747-6.906c-.234-.075-2.116-.634-4.256-.291a29.7 29.7.0 011.328 4.872 6.845 6.845.0 002.928-4.581zM10.669 14.3c-.103-.6-.497-2.688-1.456-5.181-.016.006-.031.009-.044.016-3.856 1.344-5.241 4.016-5.362 4.266a6.807 6.807.0 006.863.9zm-7.747-1.722c.156-.266 2.031-3.369 5.553-4.509a7.04 7.04.0 01.269-.081 24.04 24.04.0 00-.553-1.159c-3.409 1.022-6.722.978-7.022.975-.003.069-.003.138-.003.209.0 1.753.666 3.356 1.756 4.566zM1.313 6.609c.306.003 3.122.016 6.319-.831A43.092 43.092.0 005.098 1.825 6.854 6.854.0 001.314 6.609zM6.4 1.366a36.612 36.612.0 012.55 4c2.431-.909 3.459-2.294 3.581-2.469A6.799 6.799.0 006.4 1.366zm6.891 2.325c-.144.194-1.291 1.663-3.816 2.694.159.325.313.656.453.991.05.119.1.234.147.353 2.275-.284 4.534.172 4.759.219A6.816 6.816.0 0013.29 3.692z"/></g></symbol><symbol id="icon-facebook" viewBox="0 0 16 16"><g><path d="M9.5 3H12V0H9.5C7.57.0 6 1.57 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.271.229-.5.5-.5z"/></g></symbol><symbol id="icon-feed" viewBox="0 0 16 16"><g><path d="M2.13 11.733c-1.175.0-2.13.958-2.13 2.126.0 1.174.955 2.122 2.13 2.122a2.126 2.126.0 002.133-2.122A2.133 2.133.0 002.13 11.733zM.002 5.436v3.067c1.997.0 3.874.781 5.288 2.196a7.45 7.45.0 012.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006.0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824.0.006.0z"/></g></symbol><symbol id="icon-flickr" viewBox="0 0 16 16"><g><path d="M0 8.5a3.5 3.5.0 117 0 3.5 3.5.0 01-7 0zm9 0a3.5 3.5.0 117 0 3.5 3.5.0 01-7 0z"/></g></symbol><symbol id="icon-github" viewBox="0 0 16 16"><g><path d="M8 .198A8 8 0 005.471 15.789c.4.074.547-.174.547-.385.0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954.0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117.0.0.672-.215 2.201.82A7.672 7.672.0 018 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147.0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481.0 1.07-.009 1.932-.009 2.195.0.213.144.462.55.384A8 8 0 008.001.196z"/></g></symbol><symbol id="icon-gitlab" viewBox="0 0 28 28"><g><path d="M1.625 11.031 14 26.89.437 17.046a1.092 1.092.0 01-.391-1.203l1.578-4.813zm7.219.0h10.313L14.001 26.89zM5.75 1.469l3.094 9.562H1.625l3.094-9.562a.548.548.0 011.031.0zm20.625 9.562 1.578 4.813a1.09 1.09.0 01-.391 1.203l-13.563 9.844 12.375-15.859zm0 0h-7.219l3.094-9.562a.548.548.0 011.031.0z"/></g></symbol><symbol id="icon-google-plus" viewBox="0 0 16 16"><g><path d="M5.091 7.147v1.747h2.888c-.116.75-.872 2.197-2.888 2.197-1.737.0-3.156-1.441-3.156-3.216s1.419-3.216 3.156-3.216c.991.0 1.65.422 2.028.784L8.5 4.112c-.888-.828-2.037-1.331-3.409-1.331C2.275 2.784.0 5.059.0 7.875s2.275 5.091 5.091 5.091c2.937.0 4.888-2.066 4.888-4.975.0-.334-.037-.591-.081-.844H5.092zM16 7h-1.5V5.5H13V7h-1.5v1.5H13V10h1.5V8.5H16z"/></g></symbol><symbol id="icon-instagram" viewBox="0 0 22 22"><g><path d="M15.445.0H6.554A6.559 6.559.0 000 6.554v8.891A6.559 6.559.0 006.554 22h8.891a6.56 6.56.0 006.554-6.555V6.554A6.557 6.557.0 0015.445.0zm4.342 15.445a4.343 4.343.0 01-4.342 4.342H6.554a4.341 4.341.0 01-4.341-4.342V6.554a4.34 4.34.0 014.341-4.341h8.891a4.342 4.342.0 014.341 4.341l.001 8.891z"/><path d="M11 5.312A5.693 5.693.0 005.312 11 5.694 5.694.0 0011 16.688 5.694 5.694.0 0016.688 11 5.693 5.693.0 0011 5.312zm0 9.163a3.475 3.475.0 11-.001-6.95 3.475 3.475.0 01.001 6.95zm5.7-10.484a1.363 1.363.0 11-1.364 1.364c0-.752.51-1.364 1.364-1.364z"/></g></symbol><symbol id="icon-linkedin" viewBox="0 0 16 16"><g><path d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502.0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5A1.5 1.5.0 11.999 3.499 1.5 1.5.0 014 3.5z"/></g></symbol><symbol id="icon-mail" viewBox="0 0 22 18"><g><path fill="#000" d="M0 17.225V.776h22v16.447H0v.002zm3.011-1.815h15.978l-5.111-5.115L11 13.179l-2.877-2.883-5.112 5.114zm-1.216-1.275 5.077-5.09L1.795 3.98v10.155zm13.332-5.09 5.079 5.09V3.979l-5.079 5.066zm-4.126 1.588 8.022-8.027-16.045-.001 8.023 8.028z"/></g></symbol><symbol id="icon-medium" viewBox="0 0 24 24"><g><path d="M22.085 4.733 24 2.901V2.5h-6.634l-4.728 11.768L7.259 2.5H.303v.401L2.54 5.594c.218.199.332.49.303.783V16.96c.069.381-.055.773-.323 1.05L0 21.064v.396h7.145v-.401l-2.52-3.049a1.244 1.244.0 01-.347-1.05V7.806l6.272 13.659h.729l5.393-13.659v10.881c0 .287.0.346-.188.534l-1.94 1.877v.402h9.412v-.401l-1.87-1.831a.556.556.0 01-.214-.534V5.267a.554.554.0 01.213-.534z"/></g></symbol><symbol id="icon-npm" viewBox="0 0 16 16"><g><path d="M0 0v16h16V0H0zm13 13h-2V5H8v8H3V3h10v10z"/></g></symbol><symbol id="icon-pinterest" viewBox="0 0 16 16"><g><path d="M8 1.069A6.93 6.93.0 005.475 14.453c-.059-.547-.116-1.391.025-1.988.125-.541.813-3.444.813-3.444s-.206-.416-.206-1.028c0-.963.559-1.684 1.253-1.684.591.0.878.444.878.975.0.594-.378 1.484-.575 2.306-.166.691.344 1.253 1.025 1.253 1.231.0 2.178-1.3 2.178-3.175.0-1.659-1.194-2.819-2.894-2.819-1.972.0-3.128 1.478-3.128 3.009.0.597.228 1.234.516 1.581.056.069.066.128.047.2a95.89 95.89.0 01-.194.787c-.031.128-.1.153-.231.094-.866-.403-1.406-1.669-1.406-2.684.0-2.188 1.587-4.194 4.578-4.194 2.403.0 4.272 1.712 4.272 4.003.0 2.388-1.506 4.313-3.597 4.313-.703.0-1.362-.366-1.588-.797.0.0-.347 1.322-.431 1.647-.156.603-.578 1.356-.862 1.816a6.93 6.93.0 008.984-6.622A6.931 6.931.0 008.001 1.068z"/></g></symbol><symbol id="icon-search" viewBox="0 0 16 16"><g><path d="M15.504 13.616l-3.79-3.223c-.392-.353-.811-.514-1.149-.499a6 6 0 10-.672.672c-.016.338.146.757.499 1.149l3.223 3.79c.552.613 1.453.665 2.003.115s.498-1.452-.115-2.003zM6 10a4 4 0 110-8 4 4 0 010 8z"/></g></symbol><symbol id="icon-strava" viewBox="0 0 24 24"><g><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599 2.836 5.598h4.172L10.463.0l-7 13.828h4.169"/></g></symbol><symbol id="icon-tumblr" viewBox="0 0 16 16"><g><path d="M9.001 7v3.659c0 .928-.012 1.463.086 1.727.098.262.342.534.609.691.354.212.758.318 1.214.318.81.0 1.289-.107 2.09-.633v2.405a9.089 9.089.0 01-1.833.639A7.93 7.93.0 019.369 16a4.9 4.9.0 01-1.725-.276 4.195 4.195.0 01-1.438-.79c-.398-.343-.672-.706-.826-1.091s-.23-.944-.23-1.676V6.556H3.003V4.29c.628-.204 1.331-.497 1.778-.877a4.386 4.386.0 001.08-1.374C6.133 1.505 6.32.825 6.422.0h2.579v4H13v3H9.001z"/></g></symbol><symbol id="icon-twitter" viewBox="0 0 16 16"><g><path d="M16 3.538a6.461 6.461.0 01-1.884.516 3.301 3.301.0 001.444-1.816 6.607 6.607.0 01-2.084.797 3.28 3.28.0 00-2.397-1.034A3.28 3.28.0 007.882 6.029 9.321 9.321.0 011.116 2.598a3.284 3.284.0 001.015 4.381A3.301 3.301.0 01.643 6.57v.041A3.283 3.283.0 003.277 9.83a3.291 3.291.0 01-1.485.057 3.293 3.293.0 003.066 2.281 6.586 6.586.0 01-4.862 1.359 9.286 9.286.0 005.034 1.475c6.037.0 9.341-5.003 9.341-9.341.0-.144-.003-.284-.009-.425a6.59 6.59.0 001.637-1.697z"/></g></symbol><symbol id="icon-vimeo" viewBox="0 0 16 16"><g><path d="M15.994 4.281c-.072 1.556-1.159 3.691-3.263 6.397-2.175 2.825-4.016 4.241-5.522 4.241-.931.0-1.722-.859-2.366-2.581-.431-1.578-.859-3.156-1.291-4.734-.478-1.722-.991-2.581-1.541-2.581-.119.0-.538.253-1.256.753l-.753-.969c.791-.694 1.569-1.388 2.334-2.081 1.053-.909 1.844-1.387 2.372-1.438 1.244-.119 2.013.731 2.3 2.553.309 1.966.525 3.188.647 3.666.359 1.631.753 2.447 1.184 2.447.334.0.838-.528 1.509-1.588.669-1.056 1.028-1.862 1.078-2.416.097-.912-.262-1.372-1.078-1.372a2.98 2.98.0 00-1.184.263c.787-2.575 2.287-3.825 4.506-3.753 1.641.044 2.416 1.109 2.322 3.194z"/></g></symbol><symbol id="icon-wordpress" viewBox="0 0 16 16"><g><path d="M2 8c0 2.313 1.38 4.312 3.382 5.259L2.52 5.622A5.693 5.693.0 002 8zm10.05-.295c0-.722-.266-1.222-.495-1.612-.304-.482-.589-.889-.589-1.371.0-.537.418-1.037 1.008-1.037.027.0.052.003.078.005A6.064 6.064.0 008 2.156 6.036 6.036.0 002.987 4.79c.141.004.274.007.386.007.627.0 1.599-.074 1.599-.074.323-.018.361.444.038.482.0.0-.325.037-.687.055l2.185 6.33 1.313-3.835-.935-2.495a12.304 12.304.0 01-.629-.055c-.323-.019-.285-.5.038-.482.0.0.991.074 1.58.074.627.0 1.599-.074 1.599-.074.323-.018.362.444.038.482.0.0-.326.037-.687.055l2.168 6.282.599-1.947c.259-.809.457-1.389.457-1.889zm-3.945.806-1.8 5.095a6.148 6.148.0 003.687-.093.52.52.0 01-.043-.081L8.105 8.511zm5.16-3.315c.026.186.04.386.04.601.0.593-.114 1.259-.456 2.093l-1.833 5.16c1.784-1.013 2.983-2.895 2.983-5.051a5.697 5.697.0 00-.735-2.803zM8 0a8 8 0 100 16A8 8 0 008 0zm0 15A7 7 0 118 1a7 7 0 010 14z"/></g></symbol><symbol id="icon-youtube" viewBox="0 0 16 16"><g><path d="M15.841 4.8s-.156-1.103-.637-1.587c-.609-.637-1.291-.641-1.603-.678-2.237-.163-5.597-.163-5.597-.163h-.006s-3.359.0-5.597.163c-.313.038-.994.041-1.603.678C.317 3.697.164 4.8.164 4.8S.005 6.094.005 7.391v1.213c0 1.294.159 2.591.159 2.591s.156 1.103.634 1.588c.609.637 1.409.616 1.766.684 1.281.122 5.441.159 5.441.159s3.363-.006 5.6-.166c.313-.037.994-.041 1.603-.678.481-.484.637-1.588.637-1.588s.159-1.294.159-2.591V7.39c-.003-1.294-.162-2.591-.162-2.591zm-9.494 5.275V5.578l4.322 2.256-4.322 2.241z"/></g></symbol></svg><header class=l-header><p class="c-title p-title"><a href=https://heathhenley.github.io/ class=p-title__link>Blogging by Heathâ„¢</a></p></header><main id=main class=l-main><article class=p-article><header><h1>YOLO-ing All the Traffic Cams</h1><div><div class=c-time>Posted on
<time datetime=2023-03-11T15:40:04-05:00>Mar 11, 2023</time></div><a href=https://heathhenley.github.io/tags/python3 class=c-tag>python3</a>
<a href=https://heathhenley.github.io/tags/python class=c-tag>python</a>
<a href=https://heathhenley.github.io/tags/project class=c-tag>project</a>
<a href=https://heathhenley.github.io/tags/react class=c-tag>react</a></div></header><section id=js-article class=p-article__body><p><strong>TL;DR</strong> - Here&rsquo;s a <a href=https://heathhenley.github.io/RhodyCarCounter>web app</a> to list labelled traffic cam images from the <a href=https://www.dot.ri.gov/travel/index.php>RI DOT website</a>. I used YOLO (You Only Look Once) to detect objects (vehicles) in the images and <a href=https://fastapi.tiangolo.com/>FastAPI</a> to serve the results to a React app. The displays the cam images and results and uses <a href=https://leafletjs.com/>LeafletJS</a> to display the cameras on a map. The backend is hosted on <a href=https://railway.app/>Railway</a> and the front end on Github Pages. All the code is available on <a href=https://github.com/heathhenley/RhodyCarCounter>GitHub</a>.</p><h1 id=motivation>Motivation</h1><p>I recently completed the deeplearning.ai <a href=https://www.coursera.org/specializations/deep-learning>Deep Learning Specialization</a> on Coursera as a refresher. I have done some <a href=https://ieeexplore.ieee.org/document/8604518>work</a> that involved training an end-to-end CNN model for semantic segmentation on 3D sonar data, but I had not worked with object detection or NLP, so I took the course. Plus I was pumped that it was updated to use tensorflow and Python. Not to mention everything is developing super quickly in that field, so there were a bunch of new things to learn and conventions that had been updated based on new best practices. It&rsquo;s also great to be able to take advantage of transfer learning, and use a model architecture that is well established - so much easier to get going than building your own from scratch based on a similar approach in a paper (which is what I did for the <a href=https://ieeexplore.ieee.org/document/8604518>3D sonar project</a> using a model for 3D MRI segmentation).</p><p>RIDOT publishes streams for their traffic cams mostly along the highways, so decided to use the project as an opportunity to learn more about some tech I&rsquo;ve wanted to play with for a while (eg FastAPI and React). I decided to use the <a href=https://www.dot.ri.gov/travel/index.php>Rhode Island DOT traffic cam images</a> as the source of images for the project. So I set up an app to detect cars in the images (they update about every minute), store the results, and display them in a React app.</p><h1 id=architecure>Architecure</h1><p>The app is a full stack application stuffed into a single repo. The backend is a <a href=https://rhodycarcounter-production.up.railway.app/docs>FastAPI REST API</a> that serves the results of the object detection. The actual object detection model, <a href=https://github.com/ultralytics/ultralytics>YOLOv8 by ultalytics</a>, is run by a python worker service. The latest labelled images from each camera are dumped into an S3 bucket.The frontend is a React app pulls the results from REST API and displays them. The backend is hosted on <a href=https://railway.app/>Railway</a>, and includes three Railway services - the Worker, the API Server the and Postgres database. The front end just runs on Github Pages.</p><p>Here&rsquo;s a diagram of the overall architecture (made with <a href=https://excalidraw.com/>Excalidraw</a>):</p><p><img src=/car_counting/traffic_app_setup.png alt="App Architecture"></p><h1 id=training-the-worker>Training the Worker</h1><p>For the first pass at this tast, I actually used the YOLOv2 implementation introduced in the deeplearning.ai object detection assignment. It was pretrained on a dashcam dataset intended for self driving cars. Performance was OK, it depended a lot on the camera angle of the traffic cam. Here&rsquo;s an example where it did pretty well:</p><p><img src=/car_counting/examplegood.jpg alt="Good Job!"></p><p>And here&rsquo;s an example where it did not do so well:</p><p><img src=/car_counting/examplebad.jpg alt="Bad Job!"></p><p>It&rsquo;s still great that it worked at all given it was trained on dash cam data. It definitely needed to be fine tuned on some real traffic cam data, and that was the plan. But while searching around the internet, I found some great open source models (<a href=https://github.com/ultralytics/ultralytics>YOLOv8 by ultalytics</a>) that seemed a lot better than the set up I was using, so I swapped it out.</p><p>There is a public dataset developed in the writing of <a href=https://proceedings.neurips.cc/paper/2019/file/ee389847678a3a9d1ce9e4ca69200d06-Paper.pdf>this paper</a> constisting of a bunch of labeled (vehicles only) traffic cam images. That&rsquo;s perfect for this application - so I used a subset of that data from Kaggle to train the model for about 13 more epochs (a couple hours). The results were much better!</p><p>The model does a pretty good job detecting vehicles, it detects way more vehicles in the frame than the previous version - and it still has not been fine tuned on data from the specific traffic cams I&rsquo;m using. So that&rsquo;s on the next step list of course!</p><p>To deploy the model I set up a service on <a href=https://railway.app/>railway</a> to run through the traffic cam images, detect vehicles, and push the results (images go to an S3 bucket, vehicle counts go in a Postgres DB). It runs every 5 minutes at the moment, but that might be adjusted. The camera streams from RI DOT update about once a minute, but I don&rsquo;t want to accumulate / store too much data.</p><h1 id=camera-location-data>Camera Location Data</h1><p>This part was a grind, no way around that. I could not find any listing of the actual locations of the cameras in terms of latitude and longitude. They are only labelled in the DOT data with approximate locations (eg I-95 at Branch Ave, etc). I really wanted to drop them on a map (using <a href=https://leafletjs.com/>Leaflet.js</a>) - so I just sat on the couch with the TV on the background and plugged away at estimating their locations. I just roughly compared the camera feed to Google StreetView in the area described by the description. They aren&rsquo;t perfect, but it&rsquo;s better than &ldquo;Camera at I-95 and Branch Ave&rdquo; - especially for showing on a map view! (or doing any kind of geospatial analysis&mldr;)</p><h1 id=lessons-learned>Lessons Learned</h1><p>This is a list of some small things I remember getting stuck on, or that I learned while working on this project. I&rsquo;m sure there&rsquo;s more that I&rsquo;ve forgotten - and there&rsquo;s definitely a lot more to come as I continue to work on this project.</p><h2 id=cross-origin-resource-sharing-cors-setup-for-fastapi>Cross-Origin Resource Sharing (CORS) setup for FastAPI</h2><p>I had to set up CORS for the API server to allow my React app to make requests to it. I used the <a href=https://fastapi.tiangolo.com/tutorial/cors/>FastAPI CORS middleware</a>. This was a bit tricky for me at first, I was pretty bummed when I first started trying to hit the REST API from the frontend and couldn&rsquo;t get it working due to a bunch of <code>Cross-Origin Request Blocked</code> errors.</p><p>For context, I&rsquo;m a desktop developer (mostly C++ and Python) - so I haven&rsquo;t had to deal with CORS before. It was pretty simple to fix by following the docs and pulling in that middleware:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># This is the extra config needed to allow GET requests from anyone</span>
</span></span><span style=display:flex><span><span style=color:#75715e># after importing the middleware</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>.</span>add_middleware(
</span></span><span style=display:flex><span>    CORSMiddleware,
</span></span><span style=display:flex><span>    allow_origins<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;*&#34;</span>],
</span></span><span style=display:flex><span>    allow_credentials<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,
</span></span><span style=display:flex><span>    allow_methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;GET&#34;</span>],
</span></span><span style=display:flex><span>    allow_headers<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;*&#34;</span>],
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>Basically you need to configure your server to allow specific origins (your client) to make requests to it for each http method (GET, POST, etc). The REST API server is currently set up to allow all origins to make GET requests only.</p><h2 id=dropping-images-into-s3>Dropping Images into S3</h2><p>The worker drops images into an S3 bucket - the two gotchas that I ran into with this were related to the headers set on the &ldquo;file objects&rdquo;.</p><p>You can see in the snippet, I had to make sure to explictly set the <code>ContentType</code> and <code>CacheControl</code> headers. Maybe obvious to a web dev - but I missed it at first.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>  <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;runs/detect/predict&#39;</span>, image_name), <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    s3<span style=color:#f92672>.</span>Bucket(S3_BUCKET)<span style=color:#f92672>.</span>put_object(
</span></span><span style=display:flex><span>      Key<span style=color:#f92672>=</span>image_name, Body<span style=color:#f92672>=</span>f,
</span></span><span style=display:flex><span>      ContentType<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;image/jpeg&#39;</span>,
</span></span><span style=display:flex><span>      CacheControl<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;max-age=300&#39;</span>)
</span></span></code></pre></div><p>The <code>ContentType</code> attribute lets the browser know it&rsquo;s an image - otherwise it will try to download the file. The <code>CacheControl</code> attribute tells the browser to cache the image for 5 minutes. I chose five minutes because I&rsquo;m only running the worker through the cams every 5 minutes, so I don&rsquo;t want to be making a bunch of requests to S3 for the same image. The images for each cam are stored with the same name and overwritten each time, so if you don&rsquo;t set the <code>CacheControl</code> header, the browser will not know to update the image and even though the image has changed, it will still show the old, cached version of the image on the front end.</p><h2 id=worker-service-on-railway>Worker Service on Railway</h2><h3 id=run-pytorch-on-railway-via-ultalyticsyolov8>Run Pytorch on Railway (via Ultalytics/YOLOv8)</h3><p>Railway set up is pretty easy for simple projects. If what you&rsquo;re running is simple enough, their <a href=https://nixpacks.com/docs/getting-started>Nixpacks</a> system will build your project into a docker image and deploy it to their as a service with basically no configuration (except maybe the start command). This set up was trivial with the API Server, but took quite a while to get right with the Worker service due to the dependencies of the YOLOv8 module.</p><p>In the end - by running Nixpacks and playing around in the docker image it made locally, I figured out that in order to run <a href=https://github.com/ultralytics/ultralytics>YOLOv8 by ultalytics</a> I needed to install a libGL library and modify the default library path. Simple to type out now, but it took a while to figure out (please don&rsquo;t look at the commit history ðŸ˜…).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>variables</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>LD_LIBRARY_PATH</span>=<span style=color:#e6db74>&#34;$LD_LIBRARY_PATH:/usr/lib/x86_64-linux-gnu/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>phases</span>.<span style=color:#a6e22e>setup</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aptPkgs</span> = [<span style=color:#e6db74>&#39;...&#39;</span>, <span style=color:#e6db74>&#39;libgl1&#39;</span>]
</span></span></code></pre></div><h3 id=drop-git-lfs-to-railway-working>Drop Git LFS to Railway working</h3><p>The previous model I was using (YOLOv2) was a lot larger - so I originally had set up Git LFS to store the model weights. I found out that when railway cloned my repo, it didn&rsquo;t pull down the LFS files. This was a problem for running worker! Eg: we&rsquo;re gonna need those weights, sir. This also took me while to figure out, because I couldn&rsquo;t get it to replicate locally. The new YOLOv8 model is much smaller, so I just stored it in the repo without using LFS. I&rsquo;m sure I could have run a build command to pull down the LFS files, but I didn&rsquo;t want to spend more time on it and the weight file is only like 5 MB.</p><h3 id=more-monorepo-woes-on-railway>More Monorepo woes on Railway</h3><p>I wanted to keep my monorepo structure because it&rsquo;s nice and simple for a small project like this. I also have the YOLO worker and the API Server set up to use the database schema. I could have avoided some of this trouble by having the worker <code>GET</code> the cam list and <code>POST</code> new data to the API Server instead of creating a direct DB connection, and I&rsquo;ll do that in the future. But for now, I wanted to keep it simple. That meant two railway services from the same repo, that both use the same database schema. So there are two services on Railway that both launch from the <code>backend</code> directory (the API server and the worker). The cool thing that you can do is tell Railway (or it was really nixpacks here) to build your app using a specific config file via an environment variable (eg <code>NIXPACKS_CONFIG_FILE</code>) in the service settings. So there are now two .toml files in the <code>backend</code> directory - <code>api_nixpacks_config.toml.toml</code> and <code>worker_nixpacks_config.toml.toml</code>, to launch the API Server and the Worker respectively. This is super convenient, it did take a while to figure out how to get it working though. I finally figured out that I could use nixpacks to create the build plan (see <code>nixpacks plan</code>) it would have used by default for the python services, and just modify the plan slightly for each service. âœ…</p><h2 id=react-router-on-gihub-pages>React Router on Gihub Pages</h2><p>I set up the front end as a React.js single page app. I&rsquo;ve been wanting to learn React for a while, so this was a good excuse to do so. I used the latest version of <a href=https://reactrouter.com/en/main>React Router</a> to handle routing for the SPA, but when I got started I didn&rsquo;t realize that hosting on Github doesn&rsquo;t give the option to redirect all endpoints to the root path.</p><p>So for example, if you clicked on the <code>Map</code> link in my nav bar, you would see the url update in the address bar to <code>/Map</code> and <code>React Router</code> would step in and show the <code>Map</code> component - everything would appear to work great. But if you then refreshed the page, the request would actually go to the server (Github Pages in this case), and return <code>404</code> because <code>/Map</code> isn&rsquo;t an actual route.</p><p>If you control the server you&rsquo;re running on, the &ldquo;right way&rdquo; to set it up for an SPA is so that the server directs all routes to <code>index.html</code>. Then on the client side, <code>react-router</code> will look at the route and figure out which component to render.</p><p>Unfortunately, this isn&rsquo;t possible with Gihub Pages. And there are two workarounds I found. The first is to copy or redirect your 404&rsquo;s to <code>index.html</code> - you can actually redirect them, or even just copy <code>index.html</code> to <code>404.html</code> (maybe as a deploy step). Then the server will 404 for any route that doesn&rsquo;t technically exist, but the client side will still be able to handle the routing (and error handling for routes that really for real don&rsquo;t exist). This felt too hacky, even for me - so I didn&rsquo;t go this route (see what I did there?).</p><p>The second option I found was to use the <code>HashRouter</code> instead of the <code>BrowserRouter</code> - this will add a <code>#</code> to the url after the base of the route (so <code>/#/Map</code> instead of <code>/Map</code>). The trick is that the server will ignore everything after the <code>#</code>. This is not really recommeneded in production, I think mostly for SEO reasons, but it&rsquo;s not important for this project.</p><p>This is what I went with - it was an easy fix, pretty much just swapping in <code>createHashRouter</code> for <code>createBrowserRouter</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Using the hash router for now so that I can use GitHub pages to host it (it
</span></span></span><span style=display:flex><span><span style=color:#75715e>// doesn&#39;t allow all server routes to be redirected to index.html)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createHashRouter</span>(
</span></span><span style=display:flex><span>  [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>element</span><span style=color:#f92672>:</span> <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>TablePage</span> <span style=color:#f92672>/&gt;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>loader</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>camListLoader</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>errorElement</span><span style=color:#f92672>:</span> <span style=color:#f92672>&lt;</span>Error <span style=color:#f92672>/&gt;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/map&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>element</span><span style=color:#f92672>:</span> <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>MapPage</span> <span style=color:#f92672>/&gt;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>loader</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>camListLoaderNoStatus</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>errorElement</span><span style=color:#f92672>:</span> <span style=color:#f92672>&lt;</span>Error <span style=color:#f92672>/&gt;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><h1 id=plans-for-improvement>Plans for Improvement</h1><p>You can see my <a href=https://github.com/heathhenley/RhodyCarCounter/issues/1>plans / backlog / idea graveyard ðŸª¦</a> - I have a lot of random ideas that would be fun to implement. Some of them are just things I should really fix ðŸ˜¬- eg things I hacked together to get things working, that I now understand much better; other things are just things I want to try out ðŸ¤“. I want to get docker/docker-compose setup to spin up a dev environment with a database, some fake data and a worker to play around with. I will update with the learnings from that and whatever else I try!</p><p>If you have suggestions or would like to help, open an issue on the repo or send me and email.</p></section><footer><nav class="p-pagination c-pagination"><div class=c-pagination__ctrl><div class=c-pagination__newer><a href=https://heathhenley.github.io/posts/download-an-image-from-a-gdoc/>Newer</a></div><div class=c-pagination__older><a href=https://heathhenley.github.io/posts/simple-wreck-map/>Older</a></div></div></nav><section class=p-related><h3>See Also</h3><ul id=slider class=p-related__list><li class="p-related__item js-related__item"><a href=/posts/simple-wreck-map/><span>New England Shipwreck Map</span></a></li><li class="p-related__item js-related__item"><a href=/posts/shut-the-box/><span>Shut the Box</span></a></li><li class="p-related__item js-related__item"><a href=/posts/memoization-in-the-wild/><span>Memoization in the Wild</span></a></li><li class="p-related__item js-related__item"><a href=/posts/computing-pi-by-throwing-darts/><span>Computing Pi by Throwing Darts</span></a></li><li class="p-related__item js-related__item"><a href=/posts/python-pathlib-module/><span>Switching to the Python Pathlib Module</span></a></li></ul></section><aside class=p-author><div class="c-avatar p-author__avatar"><img alt="Author Avatar" src=/heathcropped.png></div><div class=p-author__body><p class="c-title p-author__name">Heath Henley</p><p>Just your average software developing, sonar data processing rockclimber with a taste for computational thermodynamics and cookies.</p><p><a href=mailto:heath.j.henley@gmail.com>Contact me</a></p></div></aside></footer></article></main><nav class="l-nav p-menu"><ul class=p-menu__lists><li class=p-menu__listitem><a href=/>Blog</a></li><li class=p-menu__listitem><a href=/about>About</a></li><li class=p-menu__listitem><a href=/tags>Tags</a></li><li class=p-menu__listitem><a href=/tutoring>Tutoring</a></li><li class=p-menu__listitem><a href=/writing>Writing</a></li><li class=p-menu__listitem><a href=https://sites.google.com/view/english-at-pcl/home>ESOL Class</a></li><li class=p-menu__listitem><a href=https://hhenley.darkroom.tech/>Photography</a></li></ul></nav><footer class=l-footer><ul class=c-links><li class=c-links__item><a href=https://instagram.com/feel_the_heath target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>instagram</title><use xlink:href="#icon-instagram"/></svg></a></li><li class=c-links__item><a href=https://github.com/heathhenley target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>github</title><use xlink:href="#icon-github"/></svg></a></li><li class=c-links__item><a href=https://linkedin.com/in/hhenley target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>linkedin</title><use xlink:href="#icon-linkedin"/></svg></a></li></ul><p class=p-copyright>Heath Henley
&nbsp;&bull;&nbsp;
2023
&nbsp;&bull;&nbsp;
<a href=https://heathhenley.github.io/>Blogging by Heathâ„¢</a></p></footer></body></html>